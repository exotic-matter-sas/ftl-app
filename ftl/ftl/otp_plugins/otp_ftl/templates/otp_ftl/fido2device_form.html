{% extends 'account/account_base.html' %}
{% load static %}
{% load i18n %}

{% block head %}
    <script type="application/javascript" src="{% static 'cbor.js' %}"></script>
{% endblock %}

{% block account %}
    <h3 class="text-primary">{% trans "Add a security key" %}</h3>

    <p>
        {% blocktrans %}
            A security key dongle is a small device that you can buy to help prove it’s you signing in. When we need to
            make sure it’s you, you can simply connect the key to your phone, tablet, or computer.
        {% endblocktrans %}
    </p>
    <p>
        {% blocktrans %}
            Such keys are the ones that are compatible with the U2F or FIDO2 protocol
            (Yubikey, Google Titan Security Key, etc.).<br/>
            Only recent browsers are compatible with these keys such as Google Chrome, Mozilla Firefox,
            Microsoft Edge.
        {% endblocktrans %}
    </p>

    <input id="fido2-next" class="btn btn-primary" type="submit" value="{% trans 'Next' %}">
    <p class="text-right"><a href="{% url 'otp_list' %}">{% trans 'Return to 2FA list' %}</a></p>
{% endblock %}

{% block footer %}
    <script type="application/javascript">
      'use strict';

      fetch('{% url 'otp_fido2_api_register_begin' %}', {
        method: 'POST',
      }).then(function (response) {
        if (response.ok) return response.arrayBuffer();
        throw new Error('Error getting registration data!');
      }).then(CBOR.decode).then(function (options) {
        return navigator.credentials.create(options);
      }).then(function (attestation) {
        return fetch('{% url 'otp_fido2_api_register_finish' %}', {
          method: 'POST',
          headers: {'Content-Type': 'application/cbor'},
          body: CBOR.encode({
            "attestationObject": new Uint8Array(attestation.response.attestationObject),
            "clientDataJSON": new Uint8Array(attestation.response.clientDataJSON),
          })
        });
      }).then(function (response) {
        if (response.ok) {
          window.location = '{% url 'otp_fido2_success'  %}';
        }
      }, function (reason) {
        alert(reason);
        window.location = '{% url 'otp_list' %}';
      });
    </script>
{% endblock %}
